<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SS Data Entry & Trip Report</title>

<style>
html, body{height:100%; margin:0; font-family:Arial, Helvetica, sans-serif;}
body{display:flex; flex-direction:column; background:url('ssbackgraund.png') no-repeat center center fixed; background-size:cover;}
header{display:flex; align-items:center; gap:12px; padding:10px 15px; background:rgba(174, 189, 216, 0.95);}
header img{height:90px}
.header-text{flex:1;}
header h1 { 
    margin: 0; 
    font-size: 36px;
    font-family: 'Times New Roman', Times, serif;   /* Nepal Electricity Authority */
}

header h2 { 
    margin: 2px 0; 
    font-size: 26px; 
    font-family: 'Times New Roman', Times, serif;  /* Dharan Dcs Substation 33Kv/11Kv */
}

header h3 { 
    margin: 4px 0 0 0; 
    font-size: 16px;    /* Tripping & Shutdown Data Entry System */
    text-align: center;
    font-family: 'Times New Roman', Times, serif;
}

nav{background:#004aad; display:flex; gap:15px; padding:10px;}
nav button{background:#fff; border:none; padding:8px 18px; cursor:pointer; font-weight:bold; border-radius:4px;}
.main{flex:1;}
.container{padding:15px; display:none; background:rgba(255,255,255,0.96); margin:15px; border-radius:6px; box-sizing:border-box;}
input, select, textarea{width:100%; padding:10px; margin-bottom:10px; font-size:15px; border:2px solid #777; border-radius:8px; box-sizing:border-box;}
input[readonly]{background:#eee; cursor:not-allowed;}
.success-msg{color:green; font-weight:bold; margin-top:10px;}
.error-msg{color:red; font-weight:bold; margin-top:10px;}
footer{background:#0e11bd; color:#fff; text-align:center; padding:16px;}
#editSection{display:none;}
@media(max-width:600px){
  header h1, header h2, header h3{font-size:16px;}
  nav{flex-direction:column;}
}

/* Report styles */
body.report { background-color: #a7ccf7; padding: 20px; text-align: center; }
img.report-img { 
    height: 85px; 
    margin-bottom: 5px; 
    border-radius: 59%; 
    border: 2px solid #c6d7e7; 
}

h1, h2, h3 { 
    margin: 0; 
    text-align: center; /* center all headers */
}

h1 { 
    color: blue; 
    font-size: 32px; 
    font-family: 'Times New Roman', Times, serif;
}

h2 { 
    color: blue; 
    font-size: 18px;
    font-family: 'Times New Roman', Times, serif 
}

h3 { 
    color: red; 
    font-size: 15px; 
    margin-bottom: 20px; /* optional spacing below h3 */
    font-family: 'Times New Roman', Times, serif
}

label { font-size: 18px; font-weight: bold; }
select,input,button { padding: 10px 16px; margin: 5px; font-size: 16px; border: 1px solid #777; border-radius: 6px; transition: all 0.3s ease; }
select:hover,input:hover { border-color: #333; background-color: #eef6ff; }
button { background: linear-gradient(45deg, #0057b7, #00b4d8); color: rgb(15,14,14); font-weight: bold; cursor: pointer; border: none; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
button:hover { background: linear-gradient(45deg, #2bfa23, hsl(133, 83%, 51%)); box-shadow: 0 6px 12px rgba(0,0,0,0.3); transform: scale(1.05); }
input[type="text"]#fromDate,input[type="text"]#toDate { width: 118px; font-size: 13px; }
.notice { border-radius: 12cm; padding: 3px; margin-top: 10px; font-size: 15px; color: #e41b1b; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; word-wrap: break-word; }
th,td { border: 1px solid #0b0c0c; padding: 10px; }
th { background-color: #282cf3; color: rgb(237, 241, 237); font-size: 14px; }
td { background-color: #9cd1a4; font-size: 13px; }
</style>
</head>

<body>

<!-- HEADER -->
<header>
  <img src="sslogo.png">
  <div class="header-text">
    <h1>Nepal Electricity Authority</h1>
    <h2>Dharan Dcs Substation 33Kv/11Kv</h2>
    <h3>Tripping & Shutdown Data Entry System</h3>
  </div>
</header>

<!-- NAVIGATION -->
<nav>
  <button onclick="showSection()">Home</button>
  <button onclick="showSection('entry')">Data Entry</button>
  <button onclick="showSection('update')">Re-Update</button>
  <button onclick="showSection('report')">Report</button>
</nav>

<div class="main">

<!-- DATA ENTRY -->
<div class="container" id="entry">
  <h3>Data Entry</h3>
  <select id="line" onchange="loadFeeder('feeder')">
    <option value="">लाईन छान्नुहोस्</option>
    <option>11Kv</option>
    <option>33Kv</option>
  </select>

  <select id="feeder">
    <option value="">फिडर छान्नुहोस्</option>
  </select>

  <input type="time" id="trip">
  <input type="time" id="restore" onchange="calcOutage()">
  <input type="text" id="outage" placeholder="HH:MM" readonly>
  <input type="text" id="reason" placeholder="आउटेजको कारण">
  <input type="number" id="tod" placeholder="TOD Reading">
  <input type="text" id="date" placeholder="मिति YYYY.MM.DD">
  <input type="password" id="security" placeholder="Security Code">
  <textarea id="remark" placeholder="कैफियत"></textarea>

  <button onclick="submitData()">Submit</button>
  <div id="msg"></div>
</div>

<!-- UPDATE -->
<div class="container" id="update">
  <h3>Re-Update</h3>
  <select id="uline" onchange="loadFeeder('ufeeder')">
    <option value="">लाईन</option>
    <option>11Kv</option>
    <option>33Kv</option>
  </select>

  <select id="ufeeder">
    <option value="">फिडर</option>
  </select>

  <input type="text" id="udate" placeholder="मिति YYYY.MM.DD">
  <input type="password" id="upwd" placeholder="Security Code">
  <button onclick="searchData()">Search</button>

  <div id="updateMsg"></div>

  <!-- EDIT SECTION -->
  <div id="editSection">
    <h4>Edit Data</h4>
    <input type="time" id="utrip">
    <input type="time" id="urestore" onchange="calcUpdateOutage()">
    <input type="text" id="uoutage" placeholder="HH:MM" readonly>
    <input type="text" id="ureason">
    <input type="number" id="utod">
    <textarea id="uremark"></textarea>
    <button onclick="updateData()">Update Submit</button>
  </div>
</div>

<!-- REPORT -->
<div class="container report" id="report">
  
  <h1>नेपाल विधुत प्राधिकरण</h1>
  <h2>धरान वितरण केन्द्र</h2>
  <h3>फिडर Trip & Shutdown समयको बिवरण थाहा पाउनुहोस् !!!</h3>

  <div>
    <label for="line">लाईन:</label>
    <select id="rline">
      <option value="all">ALL</option>
      <option value="33kv">33kv</option>
      <option value="11kv">11kv</option>
    </select>

    <label for="feeder">फिडर:</label>
    <select id="rfeeder">
      <option value="all">ALL</option>
      <option>Dharan Feeder</option>
      <option>Panmara Feeder</option>
      <option>Bpkish Feeder</option>
      <option>Bishnupaduka Feeder</option>
      <option>Local Chatara Feeder</option>
      <option>Bhanu Feeder</option>
      <option>Chatara Feeder</option>
      <option>Relway Feeder</option>
      <option>Industrial Feeder</option>
      <option>Chatara To Dharan Feeder33kv</option>
      <option>Dhankuta To Dharan Feeder33kv</option>
      <option>Duhabi To Dharan Feeder33kv</option>
      <option>Dharan To Chatara Feeder33kv</option>
      <option>Dharan To Dhankuta Feeder33kv</option>
      <option>Bagarkot Feeder</option>
      <option>British Feeder</option>
      <option>Khanepani Feeder</option>
      <option>Other Feeder</option>
    </select>

    <br />
    <label for="fromDate">देखि मिति:</label>
    <input type="text" id="fromDate" placeholder="YYYY-MM-DD" />
    <label for="toDate">सम्म मिति:</label>
    <input type="text" id="toDate" placeholder="YYYY-MM-DD" />

    <button onclick="searchReport()">Search</button>
    <button onclick="printTable()">Print</button>
    <button onclick="downloadExcel()">Report Download Excel</button>
  </div>

  <div class="notice">
    <b>थप जानकारीको लागि सम्पर्क नम्बर: ९८५२०६२४२१</b>
  </div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>लाईन</th>
        <th>फिडर</th>
        <th>फिडर Trip वा Shutdown समय</th>
        <th>फिडर Restore समय</th>
        <th>जम्मा आउटेज</th>
        <th>आउटेजको कारण</th>
        <th>TOD Reading</th>
        <th>मिति</th>
        <th>कैफियत</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="9">....</td></tr>
    </tbody>
  </table>
</div>

</div>

<footer>
  System developed By: Dharan Dcs | Contact: 9842459642
</footer>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbwBsl_lSeXFQi--ISM9VEdXBgH9H_1g5IvISiMf-RqTbry7YxgcjWpdcgo2sSuYfwtI/exec";
const DATA_URL="https://script.google.com/macros/s/AKfycbww0YewPUWtrLh0tV2sS1p9N2IGiRUDPv2SltIbpwAoqpfGJEz8kXtkuQ7Y9CPNF5_d/exec";

function showSection(id){
  document.querySelectorAll('.container').forEach(c=>c.style.display="none");
  if(id) document.getElementById(id).style.display="block";
}
showSection();

/* FEEDER */
function loadFeeder(t){
  const s=document.getElementById(t);
  s.innerHTML='<option value="">फिडर छान्नुहोस्</option>';
  const l=t==="feeder"?line.value:uline.value;
  let f=[];
  if(l==="11Kv") f=["Dharan Feeder","Panmara Feeder","Bpkish Feeder","Bishnupaduka Feeder","Local Chatara Feeder","Bhanu Feeder","Chatara Feeder","Relway Feeder","Industrial Feeder","Bagarkot Feeder","British Feeder","Khanepani Feeder","Other Feeder"];
  if(l==="33Kv") f=["Chatara To Dharan Feeder33kv","Dhankuta To Dharan Feeder33kv","Duhabi To Dharan Feeder33kv","Dharan To Chatara Feeder33kv","Dharan To Dhankuta Feeder33kv","Other Feeder"];
  f.forEach(x=>{ let o=document.createElement("option"); o.value=o.textContent=x; s.appendChild(o); });
}

/* OUTAGE */
function diff(t1,t2){
  let d=(new Date("1970-01-01T"+t2)-new Date("1970-01-01T"+t1))/60000;
  if(d<0)d+=1440;
  return String(Math.floor(d/60)).padStart(2,'0')+":"+String(d%60).padStart(2,'0');
}
function calcOutage(){ if(trip.value && restore.value) outage.value=diff(trip.value,restore.value); }
function calcUpdateOutage(){ if(utrip.value && urestore.value) uoutage.value=diff(utrip.value,urestore.value); }

/* DATE & SECURITY validation */
function isValidEntryDate(dateStr){ return /^\d{4}\.\d{2}\.\d{2}$/.test(dateStr); }
function isValidSecurity(code){ return code==="Dharan@ss"; }

/* SUBMIT */
function submitData(){
  const headers=["लाईन","फिडर","मिति","Security Code"];
  const values=[line.value,feeder.value,date.value,security.value];
  for(let i=0;i<headers.length;i++){
    if(!values[i]){
      msg.textContent=`⚠ ${headers[i]} Fill खाली छ कृपया Fill भर्नुहोस् !!!`;
      msg.className="error-msg"; return;
    }
  }
  if(!isValidEntryDate(date.value)){
    msg.textContent="⚠ मिति format गलत छ! YYYY.MM.DD मात्र अनुमति दिइने छ।";
    msg.className="error-msg"; return;
  }
  if(!isValidSecurity(security.value)){
    msg.textContent="⚠ Invalid Security Code !";
    msg.className="error-msg"; return;
  }
  fetch(WEB_APP_URL,{
    method:"POST",
    body:JSON.stringify({
      line:line.value,feeder:feeder.value,trip:trip.value,
      restore:restore.value,outage:outage.value,
      reason:reason.value,tod:tod.value,
      date:date.value,remark:remark.value,
      security:security.value
    })
  }).then(()=>{
    msg.textContent="✔ Data Submitted Successfully";
    msg.className="success-msg";
    document.querySelectorAll('#entry input,#entry select,#entry textarea').forEach(e=>{
      if(e.id!=="security") e.value="";
    });
    security.value="";
  });
}

/* SEARCH for Re-Update (YYYY.MM.DD only) */
let editRow=null;
function searchData(){
  const headers=["लाईन","फिडर","मिति","Security Code"];
  const values=[uline.value,ufeeder.value,udate.value,upwd.value];
  for(let i=0;i<headers.length;i++){
    if(!values[i]){
      updateMsg.textContent=`⚠ ${headers[i]} Fill खाली छ कृपया Fill भर्नुहोस् !!!`;
      updateMsg.className="error-msg"; return;
    }
  }
  if(!/^\d{4}\.\d{2}\.\d{2}$/.test(udate.value)){
    updateMsg.textContent="⚠ मिति format गलत छ! केवल YYYY.MM.DD अनुमति छ।";
    updateMsg.className="error-msg"; return;
  }
  if(!isValidSecurity(upwd.value)){
    updateMsg.textContent="⚠ Invalid Security Code !!!";
    updateMsg.className="error-msg"; return;
  }

  fetch(`${WEB_APP_URL}?line=${uline.value}&feeder=${ufeeder.value}&date=${udate.value}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.length){
      updateMsg.textContent="⚠ Data Not Found";
      updateMsg.className="error-msg";
      document.getElementById("editSection").style.display="none"; return;
    }
    editRow=d[0];
    utrip.value=editRow.trip;
    urestore.value=editRow.restore;
    uoutage.value=String(editRow.outage).slice(0,5);
    ureason.value=editRow.reason;
    utod.value=editRow.tod;
    uremark.value=editRow.remark;
    document.getElementById("editSection").style.display="block";
    updateMsg.textContent="✔ Data Loaded";
    updateMsg.className="success-msg";
  });
}

/* UPDATE */
function updateData(){
  fetch(WEB_APP_URL,{
    method:"POST",
    body:JSON.stringify({
      rowIndex:editRow.rowIndex,
      line:uline.value,feeder:ufeeder.value,
      trip:utrip.value,restore:urestore.value,
      outage:uoutage.value,reason:ureason.value,
      tod:utod.value,date:udate.value,remark:uremark.value
    })
  }).then(()=>{
    updateMsg.textContent="✔ Updated Successfully";
    updateMsg.className="success-msg";
    document.querySelectorAll('#editSection input,#editSection textarea').forEach(e=>e.value="");
    document.getElementById("editSection").style.display="none";
    editRow=null;
  });
}

/* REPORT SEARCH */
function normalizeDate(dateStr){
  if(!dateStr) return null;
  const cleaned = dateStr.replace(/[./]/g,"-").trim();
  const parts = cleaned.split("-");
  if(parts.length!==3) return null;
  let [y,m,d] = parts;
  m = m.padStart(2,'0');
  d = d.padStart(2,'0');
  return y+m+d;
}

function isDateInRange(dateStr, fromDateStr, toDateStr){
  const date = normalizeDate(dateStr);
  const from = normalizeDate(fromDateStr);
  const to = normalizeDate(toDateStr);
  if(!date) return false;
  if(!from && !to) return true;
  if(from && to) return date>=from && date<=to;
  if(from) return date>=from;
  if(to) return date<=to;
  return true;
}

function formatTime12(value){
  if(!value) return "";
  const date = new Date(value);
  if(!isNaN(date)){
    let hh = date.getHours();
    const mm = date.getMinutes().toString().padStart(2,'0');
    const ampm = hh>=12 ? "PM" : "AM";
    hh = hh%12 || 12;
    return `${hh.toString().padStart(2,'0')}:${mm} ${ampm}`;
  }
  return value;
}

function formatOutageHHMM(value){
  if(!value) return "";
  const date = new Date(value);
  if(!isNaN(date)){
    const hh = String(date.getHours()).padStart(2,'0');
    const mm = String(date.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }
  return value;
}

async function searchReport(){
  const line=document.getElementById("rline").value.trim().toLowerCase();
  const feeder=document.getElementById("rfeeder").value.trim().toLowerCase();
  const fromDate=document.getElementById("fromDate").value.trim();
  const toDate=document.getElementById("toDate").value.trim();
  const tbody=document.getElementById("tableBody");
  tbody.innerHTML="";

  // ✅ Date validation: must fill at least one
  if(fromDate === "" && toDate === ""){
    tbody.innerHTML='<tr><td colspan="9" style="color:red; font-weight:bold;">⚠ कृपया आफूलाई चाहिएको Data मिति राखि Search गर्नुहोस् !!!</td></tr>';
    return;
  }

  try{
    const res=await fetch(DATA_URL);
    const data=await res.json();

    const filtered=data.filter(row=>{
      const rowLine=(row["लाईन"]||"").toLowerCase();
      const rowFeeder=(row["फिडर"]||"").toLowerCase();
      const rowDate=(row["मिति"]||"").trim();
      const lineMatch=line==="all"||rowLine===line;
      const feederMatch=feeder==="all"||rowFeeder===feeder;
      return lineMatch && feederMatch && isDateInRange(rowDate,fromDate,toDate);
    });

    if(filtered.length===0){
      tbody.innerHTML='<tr><td colspan="9">कुनै डाटा फेला परेन !!!</td></tr>';
      return;
    }

    let totalMinutes=0;
    filtered.forEach(row=>{
      const tr=document.createElement("tr");
      let outage=row["जम्मा आउटेज"]||"";
      if(outage){
        outage=formatOutageHHMM(outage);
        const parts=outage.split(":");
        const hh=parseInt(parts[0]);
        const mm=parseInt(parts[1]);
        if(!isNaN(hh)&&!isNaN(mm)) totalMinutes+=hh*60+mm;
      }

      tr.innerHTML=`
        <td>${row["लाईन"]||""}</td>
        <td>${row["फिडर"]||""}</td>
        <td>${formatTime12(row["फिडर Trip वा Shutdown समय"])}</td>
        <td>${formatTime12(row["फिडर Restore समय"])}</td>
        <td>${outage}</td>
        <td>${row["आउटेजको कारण"]||""}</td>
        <td>${row["TOD Reading"]||""}</td>
        <td>${row["मिति"]||""}</td>
        <td>${row["कैफियत"]||""}</td>`;
      tbody.appendChild(tr);
    });

    const totalHH=Math.floor(totalMinutes/60);
    const totalMM=totalMinutes%60;
    const totalRow=document.createElement("tr");
    totalRow.innerHTML=`
      <td colspan="4" style="text-align:right;font-weight:bold;">जम्मा आउटेज समय:</td>
      <td style="font-weight:bold;">${String(totalHH).padStart(2,'0')}:${String(totalMM).padStart(2,'0')}</td>
      <td colspan="4" style="font-weight:bold;color:#000066;">जम्मा विवरण संख्या ${filtered.length} वटा ।</td>`;
    tbody.appendChild(totalRow);

  }catch(err){
    console.error(err);
    tbody.innerHTML='<tr><td colspan="9">डाटा लोड गर्न सकिएन। पछि प्रयास गर्नुहोस्।</td></tr>';
  }
}



function printTable() {
  const fromDate = document.getElementById("fromDate").value.trim();
  const toDate = document.getElementById("toDate").value.trim();

  // ✅ Date validation before printing
  if(fromDate === "" && toDate === ""){
    alert("⚠ Print गर्नकाे लागि कृपया आफूलाई चाहिएको मिति राखि Data Search  गर्नुहोस् !!!");
    return;
  }

  const table = document.getElementById("resultTable");
  const newWin = window.open("");
  newWin.document.write(`
    <html>
      <head>
        <title>Print Report</title>
        <style>
          table { width: 100%; border-collapse: collapse; font-family: 'Times New Roman'; }
          th, td { border: 1px solid black; padding: 8px; text-align: left; }
          th { background-color: #1316d3; color: white; }
          td { background-color: #9cd1a4; }
          h2 { text-align: center; }
          .signature-section {
            width: 100%;
            margin-top: 40px;
            display: flex;
            justify-content: space-around;
            font-family: 'Times New Roman', serif;
            font-size: 16px;
          }
          .signature-block { text-align: center; min-width: 150px; }
          .signature-line { border-bottom: 1px solid black; width: 175px; margin: 0 auto 6px auto; }
          .signature-name { font-weight: bold; }
          .signature-title { margin-top: 2px; font-style: italic; font-size: 14px; }
        </style>
      </head>
      <body>
        <h2>नेपाल विधुत प्राधिकरण</h2>
        <h2>धरान वितरण केन्द्र</h2>
        <h2>33kv/11kv Trip & Shutdown Report</h2>
        ${table.outerHTML}
        <div class="signature-section">
          <div class="signature-block">
            <div class="signature-line"></div>
            <div class="signature-name">Mr.Suresh Kumar Yadav</div>
            <div class="signature-title">Electrical Supervisor</div>
            <div class="signature-title">Mobile No.:-9860778510</div>
            <div class="signature-title">(S/S Incharge Data Entry)</div>
          </div>
          <div class="signature-block">
            <div class="signature-line"></div>
            <div class="signature-name">Mr.MaheshRaj Dahal</div>
            <div class="signature-title">Electrical Supervisor</div>
            <div class="signature-title">Mobile No.:-9852063421</div>
            <div class="signature-title">(Technical Incharge Checked By)</div>
          </div>
          <div class="signature-block">
            <div class="signature-line"></div>
            <div class="signature-name">Er.Hari Ram Pokharel</div>
            <div class="signature-title">Electrical Engineer</div>
            <div class="signature-title">Mobile No.:-9852062421</div>
            <div class="signature-title">(Branch Chief Approve By)</div>
          </div>
        </div>
      </body>
  `);
  newWin.document.close();
  newWin.print();
}


function downloadExcel() {
  const table = document.getElementById("resultTable");
  const rows = table.querySelectorAll("tbody tr");
  if (rows.length<=1 || rows[0].cells[0].innerText==="...." || table.innerText.includes("कुनै डाटा फेला परेन")){
    alert("कृपया पहिला  मिति राखि  Data Search गर्नुहोस् !!! टेबलमा डाटा देखायपछि मात्र Excel Download गर्न सक्नुहुनेछ !!! धन्यवाद !!!");
    return;
  }
  const wb = XLSX.utils.book_new();
  const ws_data=[["लाईन","फिडर","फिडर Trip वा Shutdown समय","फिडर Restore समय","जम्मा आउटेज","आउटेजको कारण","TOD Reading","मिति","कैफियत"]];
  rows.forEach(row=>{
    const rowData=[];
    row.querySelectorAll("td").forEach(td=>rowData.push(td.innerText));
    if(!rowData[0].includes("जम्मा आउटेज समय")) ws_data.push(rowData);
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb,"Trip & Shutdown_Report.xlsx");
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
